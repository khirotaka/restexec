services:
  restexec:
    build:
      context: ./services/restexec
      dockerfile: Dockerfile
    container_name: restexec
    ports:
      - "3000:3000"
    environment:
      - PORT=${PORT:-3000}
      - WORKSPACE_DIR=${WORKSPACE_DIR:-/workspace}
      - TOOLS_DIR=${TOOLS_DIR:-/tools}
      - DEFAULT_TIMEOUT=${DEFAULT_TIMEOUT:-5000}
      - MAX_TIMEOUT=${MAX_TIMEOUT:-300000}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - DENO_PATH=${DENO_PATH:-deno}
      - DENO_ALLOW_READ=${DENO_ALLOW_READ:-/workspace,/tools}
      - DENO_ALLOW_WRITE=${DENO_ALLOW_WRITE:-}
      - DENO_ALLOW_NET=${DENO_ALLOW_NET:-}
      - DENO_ALLOW_RUN=${DENO_ALLOW_RUN:-false}
      - DENO_IMPORT_MAP=${DENO_IMPORT_MAP:-/workspace/import_map.json}
    volumes:
      # Mount workspace and tools directories
      - ./services/restexec/example/workspace:/workspace
      - ./services/restexec/example/tools:/tools
      # For development: mount source code to enable changes without rebuilding
      # Uncomment the following lines for development mode
      # - ./services/restexec/src:/app/src:ro
      # - ./services/restexec/deno.json:/app/deno.json:ro
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - restexec-network

  mcp-gateway:
    build:
      context: ./services/mcp-gateway
      dockerfile: Dockerfile
    container_name: mcp-gateway
    ports:
      - "3001:3001"
    environment:
      - PORT=${MCP_GATEWAY_PORT:-3001}
      - LOG_LEVEL=${MCP_GATEWAY_LOG_LEVEL:-INFO}
      - LOG_INCLUDE_STACK=${MCP_GATEWAY_LOG_INCLUDE_STACK:-false}
      - CONFIG_PATH=/config/config.yaml
      - DEFAULT_TIMEOUT=${MCP_GATEWAY_DEFAULT_TIMEOUT:-30000}
      - MAX_TIMEOUT=${MCP_GATEWAY_MAX_TIMEOUT:-300000}
      - HEALTH_CHECK_INTERVAL=${MCP_GATEWAY_HEALTH_CHECK_INTERVAL:-30000}
      - MCP_SERVER_RESTART_POLICY=${MCP_GATEWAY_RESTART_POLICY:-never}
      - DISABLE_VALIDATION=${MCP_GATEWAY_DISABLE_VALIDATION:-false}
    volumes:
      # Mount config file (required)
      - ./services/mcp-gateway/config/config.yaml:/config/config.yaml:ro
      - ./services/mcp-gateway/tests/test_server/sample-mcp-server:/app/sample-mcp-server
      # For development: mount source code to enable changes without rebuilding
      # Uncomment the following lines for development mode
      # - ./services/mcp-gateway/internal:/app/internal:ro
      # - ./services/mcp-gateway/cmd:/app/cmd:ro
    restart: unless-stopped
    # Healthcheck is disabled because distroless/static image doesn't include tools like wget or curl
    # Monitor the service using application logs or external monitoring tools instead
    networks:
      - restexec-network

networks:
  restexec-network:
    driver: bridge

volumes:
  workspace:
  tools:
